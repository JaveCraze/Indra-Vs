[gd_scene load_steps=20 format=3 uid="uid://eb45g6exg3qh"]

[ext_resource type="Texture2D" uid="uid://djy8ppnshq75b" path="res://icon.svg" id="1_rc4rb"]
[ext_resource type="Texture2D" uid="uid://bgmafcpbp4s74" path="res://placeholderanim.png" id="2_e40cc"]
[ext_resource type="Texture2D" uid="uid://b0t1eyy7gvjg0" path="res://characteranim-Sheet.png" id="3_ikpvk"]

[sub_resource type="GDScript" id="GDScript_vsbh0"]
script/source = "extends CharacterBody2D
@onready var anim = $IndraAnimator
var basespeed = 500.0
var slidespeed = 900
var walljumpbegin = false
var SPEED = basespeed
const JUMP_VELOCITY = -600.0
var walljumpvelocity = 600
enum States {Ground, Jumping, Falling, On_Wall, Walljumping, Walking, Crouching, Sneaking, Sliding}
enum WeaponStates {Fist, Pipe}
var nojumps = false
var state : int = States.Ground
var gravity = ProjectSettings.get_setting(\"physics/2d/default_gravity\")
var coyote = false
var coyote_frames = 3
var lookinleft = false
var justjumped = false
var coyotestarted = false
var jumpbuffer = false
var canwallcolcheck = true
var wallslow = true
var timerstarted = false
var cantuncrouch = false
var sliding = false
var attacking = false 
@onready var Standingcshape = $PlayerCol
@onready var Crouchingcshape = $CrouchCol
@onready var hitbox = $HitArea

signal paused

func _ready():
	Gamemanager.player = self
	state = WeaponStates.Fist

func jump():
	velocity.y = JUMP_VELOCITY
	justjumped = true
	if state != States.Walljumping:
		state = States.Jumping
func die():
	Gamemanager.respawn_player()
func _on_coyote_timer_timeout():
	coyote = false
func _on_jump_buffer_timeout():
	jumpbuffer = false
func _on_wall_slow_timer_timeout():
	wallslow = false
func _on_slide_timer_timeout():
		sliding = false
		print(\"slideend\")
func _on_wall_col_check_timer_timeout():
	canwallcolcheck = true
func _on_attack_timer_timeout():
	attacking = false
	hitbox.monitoring = false
func beginslide():
	state = States.Sliding
	if sliding == false:
		$SlideTimer.start()
		sliding = true
		print(\"slidestart\")
func handle_wall_jump():
	if state != States.On_Wall: return
	var wall_normal = get_wall_normal()
	#handle wall jump
	if Input.is_action_just_pressed(\"up\") and wall_normal == Vector2.LEFT and state != States.Walljumping: #and !Input.is_action_pressed(\"right\"):
		print(\"walljump\")
		state = States.Walljumping
		walljumpbegin = true
		velocity.x = 0
		velocity.x -= walljumpvelocity
		jump()
		if lookinleft == false:
			lookinleft = true
			scale.x = -1.0
	if Input.is_action_just_pressed(\"up\") and wall_normal == Vector2.RIGHT and state != States.Walljumping: #and !Input.is_action_pressed(\"left\"):
		print(\"walljump\")
		state = States.Walljumping
		walljumpbegin = true
		velocity.x = 0
		velocity.x += walljumpvelocity
		jump()
		if lookinleft == true:
			lookinleft = false
			scale.x = -1.0
func handle_attack():
	if Input.is_action_just_pressed(\"attack\"):
		if attacking == false:
			$AttackTimer.start()
			hitbox.monitoring = true
			attacking = true
func _on_killzone_body_entered(_body):
	print(\"dead\")
	die()
func _physics_process(delta):
	get_wall_normal()
	var direction = Input.get_axis(\"left\", \"right\")
	if state != States.Walljumping and state != States.Sliding:
		if direction:
			velocity.x = direction * SPEED
		else:
			velocity.x = move_toward(velocity.x, 0, SPEED)
	if direction != 0 and state != States.Walljumping:
		if direction >0 and lookinleft == true:
			lookinleft = false
			scale.x = -1.0
		if direction <0 and lookinleft == false: 
			lookinleft = true
			scale.x = -1.0
	handle_wall_jump()
	handle_attack()
	if state == States.Jumping:
		anim.play(\"jump\")
	if state == States.Walljumping:
		if walljumpbegin == true:
			canwallcolcheck = false
		$WallColCheckTimer.start()
		anim.play(\"walljump\")
		#if velocity.x > 0:
				#Input.action_press(\"right\")
		#if velocity.x < 0:
				#Input.action_press(\"left\")
		if is_on_wall():
			if !Input.is_action_just_pressed(\"up\"):
				state = States.On_Wall

	Crouchingcshape.disabled = true
	Standingcshape.disabled = false
	if not is_on_floor():
		velocity.y += gravity * delta
		if Input.is_action_just_pressed(\"up\"):
			$JumpBuffer.start()
			jumpbuffer = true

	if $AboveCollision.is_colliding() or $AboveCollision2.is_colliding() or $AboveCollision3.is_colliding():
		cantuncrouch = true
	else:
		cantuncrouch = false

	if Input.is_action_just_pressed(\"pause\"):
		get_tree().paused = true
		emit_signal(\"paused\")
		

#Manages groundedstate
	if is_on_floor() and !cantuncrouch and state != States.Sliding and velocity.x == 0:
		state = States.Ground
		nojumps = false
		justjumped = false
		walljumpbegin = false
		coyotestarted = false
	if velocity.y > 0 and !cantuncrouch and state != States.On_Wall:
		state = States.Falling

#Manages jump buffer jumping when hit floor
	if is_on_floor():
		if jumpbuffer == true:
			jump()
			jumpbuffer = false

	if velocity.x < 0 and is_on_floor() or velocity.x > 0 and is_on_floor():
		if not Input.is_action_pressed(\"down\") and sliding == false and !cantuncrouch:
			state = States.Walking

	#if Input.is_action_pressed(\"scan\") and state == States.Ground:
		#pass
		#enter scanning state
		#instantialize scan radar 
#Wallhang code
	if !is_on_floor() and is_on_wall():
		var wall_normal = get_wall_normal()
		if wall_normal == Vector2.RIGHT and !Input.is_action_just_pressed(\"up\") and Input.is_action_pressed(\"left\") and ($Wallcheck.is_colliding() or $Wallcheck2.is_colliding()): #or velocity.x < 0:
			state = States.On_Wall
			velocity.y *= .85
		if wall_normal == Vector2.LEFT and !Input.is_action_just_pressed(\"up\") and Input.is_action_pressed(\"right\") and ($Wallcheck.is_colliding() or $Wallcheck2.is_colliding()): #or velocity.x > 0:
			state = States.On_Wall
			velocity.y *= .85

	if !is_on_floor() and justjumped == false and coyotestarted == false: #and coyote == false:
		$CoyoteTimer.start()
		coyote = true
		coyotestarted = true
#Crouch code
	if state == States.Ground:
		anim.play(\"idle\")
		sliding = false
		if Input.is_action_pressed(\"down\"):
			if velocity.x == 0:
				state = States.Crouching
#Slide code
	if state == States.Walking:
		anim.play(\"walk\")
		if Input.is_action_just_pressed(\"down\"):
			state = States.Sliding
			if sliding == false:
				$SlideTimer.start()
				sliding = true
#More slide code
	if Input.is_action_pressed(\"down\"):
		#if wall is above character
		#disable crouch
		if state == States.Walking:
			beginslide()
		if Input.is_action_just_pressed(\"right\"):
			beginslide()
		if Input.is_action_just_pressed(\"left\"):
			beginslide()
	#else: 
		#Standingcshape.disabled = false
		#Crouchingcshape.disabled = true
#Sliding code...
	if state == States.Sliding:
		anim.play(\"slide\")
		Standingcshape.disabled = true
		Crouchingcshape.disabled = false
		SPEED = slidespeed 
		if sliding == false:
			if cantuncrouch == false:
				velocity.x = 0
		if velocity.x == 0:
			state = States.Ground
	else:
		SPEED = basespeed

	if state == States.Crouching:
		anim.play(\"crouch\")
		Standingcshape.disabled = true
		Crouchingcshape.disabled = false


	if state == States.Falling:
		anim.play(\"fall\")
		velocity.y += 20

	if state == States.On_Wall:
		if Input.is_action_just_pressed(\"right\"):
			state = States.Falling
		if Input.is_action_just_pressed(\"left\"):
			state = States.Falling
		if !is_on_wall() and !$Wallcheck.is_colliding() and !$Wallcheck2.is_colliding():
			state = States.Falling
		anim.play(\"onwall\")
		if velocity.y > 0:
			if Input.is_action_just_pressed(\"down\"):
				wallslow = false
			if wallslow == true:
				gravity = 300
				if timerstarted == false:
					$WallSlowTimer.start()
					timerstarted = true
			else:
				gravity = ProjectSettings.get_setting(\"physics/2d/default_gravity\")
				velocity.y *= 1.15
			if velocity.y > 600:
				state = States.Falling
	else:
		wallslow = true
		timerstarted = false
		gravity = ProjectSettings.get_setting(\"physics/2d/default_gravity\")

	# Handle Jump.
	if Input.is_action_just_pressed(\"up\") and (is_on_floor() or coyote) and state != States.Walljumping and !cantuncrouch:
		jump()
		
	#Handle Double Jump
	#if Input.is_action_just_pressed(\"up\") and !is_on_floor() and _state != 3 and nojumps == false and justjumped == true:
	#	jump()
	#	nojumps = true
	#if Input.is_action_just_released(\"up\"):
		#velocity.y *= .60
	if not Input.is_action_pressed(\"up\") and state == States.Jumping:
		velocity.y *= .90
	move_and_slide()


func _on_hit_area_body_entered(body):
	body.health -= 1
	print(body.name)
















"

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_g1m73"]
radius = 19.0
height = 92.0

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_rqd24"]
radius = 19.0
height = 45.7338

[sub_resource type="GDScript" id="GDScript_bmjrg"]
script/source = "extends Label
@onready var player = get_parent()

# Called when the node enters the scene tree for the first time.
func _ready():
	pass # Replace with function body.


# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(_delta):
	if player.state == player.States.Ground:
		text = (\"grounded\")
	if player.state == player.States.Jumping:
		text = (\"jumping\")
	if player.state == player.States.Falling:
		text = (\"falling\")
	if player.state == player.States.On_Wall:
		text = (\"wall\")
	if player.state == player.States.Walljumping:
		text = (\"walljumping\")
	if player.state == player.States.Walking:
		text = (\"walking\")
	if player.state == player.States.Crouching:
		text = (\"crouching\")
	if player.state == player.States.Sneaking:
		text = (\"sneaking\")
	if player.state == player.States.Sliding:
		text = (\"sliding\")
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_j0dwg"]
size = Vector2(109.833, 78.3333)

[sub_resource type="Animation" id="Animation_nf2le"]
resource_name = "Idle"

[sub_resource type="AnimationLibrary" id="AnimationLibrary_xpt2j"]
_data = {
"Idle": SubResource("Animation_nf2le")
}

[sub_resource type="AtlasTexture" id="AtlasTexture_711ci"]
atlas = ExtResource("3_ikpvk")
region = Rect2(900, 0, 180, 180)

[sub_resource type="AtlasTexture" id="AtlasTexture_21213"]
atlas = ExtResource("3_ikpvk")
region = Rect2(540, 0, 180, 180)

[sub_resource type="AtlasTexture" id="AtlasTexture_0drqw"]
atlas = ExtResource("3_ikpvk")
region = Rect2(0, 0, 180, 180)

[sub_resource type="AtlasTexture" id="AtlasTexture_elqlu"]
atlas = ExtResource("3_ikpvk")
region = Rect2(360, 0, 180, 180)

[sub_resource type="AtlasTexture" id="AtlasTexture_o7ygq"]
atlas = ExtResource("3_ikpvk")
region = Rect2(1080, 0, 180, 180)

[sub_resource type="AtlasTexture" id="AtlasTexture_venv7"]
atlas = ExtResource("3_ikpvk")
region = Rect2(720, 0, 180, 180)

[sub_resource type="AtlasTexture" id="AtlasTexture_3vgd5"]
atlas = ExtResource("3_ikpvk")
region = Rect2(180, 0, 180, 180)

[sub_resource type="AtlasTexture" id="AtlasTexture_36jec"]
atlas = ExtResource("3_ikpvk")
region = Rect2(1260, 0, 180, 180)

[sub_resource type="SpriteFrames" id="SpriteFrames_ko7na"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_711ci")
}],
"loop": true,
"name": &"crouch",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_21213")
}],
"loop": true,
"name": &"fall",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_0drqw")
}],
"loop": true,
"name": &"idle",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_elqlu")
}],
"loop": true,
"name": &"jump",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_o7ygq")
}],
"loop": true,
"name": &"onwall",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_venv7")
}],
"loop": true,
"name": &"slide",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_3vgd5")
}],
"loop": true,
"name": &"walk",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_36jec")
}],
"loop": true,
"name": &"walljump",
"speed": 5.0
}]

[node name="Player" type="CharacterBody2D"]
position = Vector2(505, 299)
collision_layer = 2
platform_floor_layers = 4294967265
platform_wall_layers = 1
script = SubResource("GDScript_vsbh0")

[node name="Sprite2D" type="Sprite2D" parent="."]
visible = false
scale = Vector2(0.476563, 0.654297)
texture = ExtResource("1_rc4rb")

[node name="PlayerCol" type="CollisionShape2D" parent="."]
position = Vector2(0, -5)
rotation = 3.14159
shape = SubResource("CapsuleShape2D_g1m73")

[node name="CrouchCol" type="CollisionShape2D" parent="."]
position = Vector2(0, 17.8669)
rotation = 3.14159
shape = SubResource("CapsuleShape2D_rqd24")
disabled = true

[node name="States" type="Label" parent="."]
offset_left = -33.0
offset_top = -73.0
offset_right = 7.0
offset_bottom = -50.0
horizontal_alignment = 1
vertical_alignment = 1
script = SubResource("GDScript_bmjrg")

[node name="SlideTimer" type="Timer" parent="."]
wait_time = 0.5
one_shot = true

[node name="CoyoteTimer" type="Timer" parent="."]
wait_time = 0.5
one_shot = true

[node name="JumpBuffer" type="Timer" parent="."]
wait_time = 0.2
one_shot = true

[node name="WallSlowTimer" type="Timer" parent="."]
one_shot = true

[node name="AttackTimer" type="Timer" parent="."]
wait_time = 0.7
one_shot = true

[node name="AboveCollision" type="RayCast2D" parent="."]
target_position = Vector2(0, -40)
hit_from_inside = true
collide_with_areas = true

[node name="AboveCollision2" type="RayCast2D" parent="."]
position = Vector2(16, 0)
target_position = Vector2(0, -40)
hit_from_inside = true
collide_with_areas = true

[node name="AboveCollision3" type="RayCast2D" parent="."]
position = Vector2(-16, 0)
target_position = Vector2(0, -40)
hit_from_inside = true
collide_with_areas = true

[node name="WallColCheckTimer" type="Timer" parent="."]
process_callback = 0
wait_time = 0.001
one_shot = true

[node name="HitArea" type="Area2D" parent="."]
collision_layer = 2
collision_mask = 16
monitoring = false

[node name="HitboxCol" type="CollisionShape2D" parent="HitArea"]
position = Vector2(88.4167, -2.83336)
shape = SubResource("RectangleShape2D_j0dwg")

[node name="Sprites" type="Sprite2D" parent="."]
visible = false
position = Vector2(7, -16)
texture = ExtResource("2_e40cc")

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
libraries = {
"": SubResource("AnimationLibrary_xpt2j")
}

[node name="IndraAnimator" type="AnimatedSprite2D" parent="."]
texture_filter = 1
position = Vector2(5, -3)
sprite_frames = SubResource("SpriteFrames_ko7na")
animation = &"walk"

[node name="Wallcheck" type="RayCast2D" parent="."]
position = Vector2(0, -9)
target_position = Vector2(35, 0)

[node name="Wallcheck2" type="RayCast2D" parent="."]
position = Vector2(0, -9)
target_position = Vector2(-35, 0)

[connection signal="timeout" from="SlideTimer" to="." method="_on_slide_timer_timeout"]
[connection signal="timeout" from="CoyoteTimer" to="." method="_on_coyote_timer_timeout"]
[connection signal="timeout" from="JumpBuffer" to="." method="_on_jump_buffer_timeout"]
[connection signal="timeout" from="WallSlowTimer" to="." method="_on_wall_slow_timer_timeout"]
[connection signal="timeout" from="AttackTimer" to="." method="_on_attack_timer_timeout"]
[connection signal="timeout" from="WallColCheckTimer" to="." method="_on_wall_col_check_timer_timeout"]
[connection signal="body_entered" from="HitArea" to="." method="_on_hit_area_body_entered"]
